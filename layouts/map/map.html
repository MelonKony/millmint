{{- partial "params.html" . -}}

<!DOCTYPE html>
<html lang='{{ .Site.LanguageCode }}'>
{{- partial "head.html" . -}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<body {{if .Params.Color }}data-color="{{ .Params.Color }}" {{ end }} class="show-all-images">
  <main>
    <div class="floating-nav">
      {{- partial "header.html" . -}}
      {{- partial "nav.html" . -}}
    </div>

    <div id="map-container">
      <!-- Fallback content that will be replaced by the map if successful -->
      <div id="map-loading">Loading map...</div>
    </div>

    <!-- Debug info panel (hidden by default) -->
    <div id="map-debug" style="position: fixed; bottom: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; max-width: 300px; display: none; font-size: 12px; overflow: auto; max-height: 200px;"></div>
  </main>
  {{- partial "resources/js.html" . -}}
  {{- partial "script.html" . -}}
</body>

<!-- Leaflet script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  // Debug helper function
  function debug(message) {
    console.log("[Map Debug]", message);
    const debugEl = document.getElementById('map-debug');
    if (debugEl) {
      const timestamp = new Date().toLocaleTimeString();
      debugEl.innerHTML += `<div><strong>${timestamp}</strong>: ${message}</div>`;
      debugEl.style.display = 'block';
    }
  }

  // Show any errors that occur
  window.addEventListener('error', function(e) {
    debug(`ERROR: ${e.message} at ${e.filename}:${e.lineno}`);
  });

  // Start initializing as soon as possible
  debug("Starting map initialization");

  // Explicitly get the map source from Hugo parameters
  const mapSource = "{{ .Params.map }}";
  debug(`Map source: ${mapSource}`);

  // Function to initialize the map
  function initializeMap() {
    try {
      debug("Initializing map...");

      // Verify the container exists
      const mapContainer = document.getElementById('map-container');
      if (!mapContainer) {
        throw new Error("Map container not found");
      }
      debug("Map container found");

      // Load test image to verify the image path is correct and accessible
      const testImg = new Image();
      testImg.onload = function() {
        debug(`Test image loaded successfully: ${testImg.width}x${testImg.height}`);
        createLeafletMap(testImg.width, testImg.height);
      };

      testImg.onerror = function() {
        debug(`ERROR: Failed to load image from: ${mapSource}`);
        mapContainer.innerHTML = `
          <div style="padding: 20px; background: #f8d7da; color: #721c24; text-align: center;">
            <h3>Map Image Failed to Load</h3>
            <p>Could not load image from: ${mapSource}</p>
            <p>Please check that the image path is correct and the file exists on the server.</p>
          </div>
        `;
      };

      debug(`Loading test image from: ${mapSource}`);
      testImg.src = mapSource;
    } catch (err) {
      debug(`Initialization error: ${err.message}`);
      document.getElementById('map-container').innerHTML = `
        <div style="padding: 20px; background: #f8d7da; color: #721c24; text-align: center;">
          <h3>Map Initialization Error</h3>
          <p>${err.message}</p>
        </div>
      `;
    }
  }

  // Function to create the actual Leaflet map
  function createLeafletMap(imgWidth, imgHeight) {
    try {
      debug(`Creating Leaflet map with image dimensions: ${imgWidth}x${imgHeight}`);

      // Initialize with hardcoded fallback dimensions if needed
      if (!imgWidth || !imgHeight) {
        debug("WARNING: Using fallback dimensions");
        imgWidth = imgWidth || 1000;
        imgHeight = imgHeight || 1000;
      }

      // Initialize the map with basic options
      const map = L.map('map-container', {
        crs: L.CRS.Simple,
        minZoom: -3,
        maxZoom: 4,
        zoomControl: false
      });

      debug("Map object created");

      // Calculate bounds based on image dimensions
      const bounds = [[0, 0], [imgHeight, imgWidth]];

      // Create the image overlay
      const imageOverlay = L.imageOverlay(mapSource, bounds).addTo(map);
      debug("Image overlay added to map");

      // Add event listener for when the image loads
      imageOverlay.once('load', function() {
        debug("Image overlay loaded successfully");
      });

      // Set the initial view
      map.fitBounds(bounds);
      debug("Map view set to fit bounds");

      // Add zoom control
      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);
      debug("Zoom controls added");

      // Setup dark mode observer
      setupDarkModeObserver();
      debug("Map initialization complete");

      // Hide the loading message
      document.getElementById('map-loading').style.display = 'none';
    } catch (err) {
      debug(`Leaflet creation error: ${err.message}`);
      document.getElementById('map-container').innerHTML = `
        <div style="padding: 20px; background: #f8d7da; color: #721c24; text-align: center;">
          <h3>Leaflet Map Creation Error</h3>
          <p>${err.message}</p>
        </div>
      `;
    }
  }

  // Setup dark mode observer
  function setupDarkModeObserver() {
    debug("Setting up dark mode observer");
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.attributeName === 'data-theme') {
          const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
          const mapContainer = document.getElementById('map-container');

          if (isDarkMode) {
            mapContainer.classList.add('dark-mode');
          } else {
            mapContainer.classList.remove('dark-mode');
          }
          debug(`Dark mode ${isDarkMode ? 'enabled' : 'disabled'}`);
        }
      });
    });

    observer.observe(document.documentElement, { attributes: true });
  }

  // Make sure DOM is loaded before initialization
  if (document.readyState === 'loading') {
    debug("DOM still loading, waiting for DOMContentLoaded");
    document.addEventListener('DOMContentLoaded', initializeMap);
  } else {
    debug("DOM already loaded, initializing immediately");
    initializeMap();
  }

  // Add backup initialization in case something goes wrong with the event listeners
  window.setTimeout(function() {
    if (document.getElementById('map-loading').style.display !== 'none') {
      debug("BACKUP: Map not initialized after 3 seconds, trying again");
      initializeMap();
    }
  }, 3000);
</script>

<style>
  body {
    background-color: rgb(226 243 253);
    margin: 0;
    overflow: hidden;
  }

  body main {
    margin-top: 0!important;
    margin-bottom: 0!important;
    position: relative;
    z-index: 1;
    height: calc(100vh - 24px);
    padding-bottom: 0;
  }

  #map-container {
    height: 100vh;
    width: 100vw;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 0;
    margin-left: calc((100% - 100vw) / 2);
  }

  #map-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.8);
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
  }

  .leaflet-bottom {
    bottom: 10px;
  }

  .leaflet-right {
    right: 40px;
  }

  .leaflet-container {
    background: var(--map-background, rgb(226 243 253));
  }

  /* Ensure map images ignore lazy loading */
  .leaflet-container img,
  .leaflet-image-layer img {
    loading: eager !important;
  }

  /* Style adjustments for dark mode */
  #map-container.dark-mode .leaflet-tile,
  #map-container.dark-mode .leaflet-image-layer {
    filter: hue-rotate(200deg) invert(95%) saturate(60%) sepia(0%) brightness(100%);
  }

  /* Make sure controls are still visible in dark mode */
  #map-container.dark-mode .leaflet-control {
    background-color: rgba(50, 50, 50, 0.8);
    color: #fff;
  }
</style>