<style>
  .close-btn {
    color: var(--highlight);
    float: right;
    cursor: pointer;
    font-size: 14px;
    margin-left: auto;
  }

  #notice {
    margin: .5rem 0 0 0;
    display: none;
    align-items: center;
  }

  .close-btn:hover {
    opacity: .5;
  }

  span.new-tag {
    margin-right: 5px;
    line-height: .8rem;
  }
  
  span.nav-tag {
    font-size: 0.6rem;
    margin-left: 5px;
  }

  @media only screen and (max-width: 500px) {
    span.nav-tag {
      display: none;
    }
  }
</style>

<blockquote id="notice" class="note panel" style="padding: .5rem;">
  {{ range ( where .Site.RegularPages "Type" "stories" | first 1 ) }}
    <span class="tag new-tag">NEW</span> <a
      style="white-space: nowrap; overflow:hidden;" href="{{ .Permalink }}"><span class="navicon">üìó</span>Story: <i>{{ .Title }}</i></a>
    <span id="close-btn" class="navicon close-btn">‚ùå</span>
  {{ end }}
</blockquote>

<script>
  function getStorageItem(key, defaultValue = []) {
    try {
      return JSON.parse(localStorage.getItem(key)) || defaultValue;
    } catch {
      return defaultValue;
    }
  }

  function setStorageItem(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.warn('Failed to save to localStorage:', e);
    }
  }

  function checkNewStories() {
    const notice = document.querySelector("#notice");
    const storiesLink = document.querySelector(`.menu-link[href="/stories/"]`);
    
    if (!notice || !storiesLink) return;

    const noticesSeen = getStorageItem("noticesSeen");
    const noticesVisited = getStorageItem("noticesVisited");
    const noticeLink = notice.querySelector("a");
    
    if (!noticeLink) return;
    
    const currentNoticeHref = noticeLink.href;

    if (location.pathname.startsWith('/stories/')) {
      noticesVisited.push(currentNoticeHref);
      setStorageItem("noticesVisited", noticesVisited);
    }

    if (!noticesVisited.includes(currentNoticeHref)) {
      const newTag = document.createElement("span");
      newTag.classList.add("tag", "new-tag", "nav-tag");
      newTag.textContent = "NEW";
      storiesLink.insertBefore(newTag, storiesLink.children[2]);
    }

    if (noticesSeen.includes(currentNoticeHref)) {
      notice.style.display = "none";
      return;
    }

    notice.style.display = "flex";

    const hideNotice = () => {
      noticesSeen.push(currentNoticeHref);
      setStorageItem("noticesSeen", noticesSeen);
      notice.style.display = "none";
    };

    notice.querySelector("#close-btn").addEventListener("click", hideNotice);
    noticeLink.addEventListener("click", hideNotice);
  }

  document.addEventListener("DOMContentLoaded", checkNewStories);
</script>