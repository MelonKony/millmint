{{/*
  Shortcode: national index
  Generates a hierarchical list by analyzing URL paths and parsing page content.
*/}}

{{ $allPages := where .Site.RegularPages ".Params.national-index" true }}

{{/* Group pages by their type and hierarchy */}}
{{ $byMinistry := dict }}
{{ $byParliament := dict }}
{{ $byIndustryType := dict }}
{{ $bySeries := dict }}
{{ $standalone := slice }}

{{ range $allPages }}
  {{ $path := .RelPermalink }}
  {{ $series := .Params.series }}
  
  {{ if in $path "/ministries/" }}
    {{ $ministryName := replaceRE `^.*?/ministries/([^/]+).*` "$1" $path }}
    {{ if $ministryName }}
      {{ $existing := index $byMinistry $ministryName | default (dict "main" slice "children" slice) }}
      {{ if eq $series "ministry" }}
        {{ $mainPages := $existing.main | append . }}
        {{ $existing = merge $existing (dict "main" $mainPages) }}
      {{ else }}
        {{ $childrenPages := $existing.children | append . }}
        {{ $existing = merge $existing (dict "children" $childrenPages) }}
      {{ end }}
      {{ $byMinistry = merge $byMinistry (dict $ministryName $existing) }}
    {{ end }}

  {{ else if in $path "/parliaments/" }}
    {{ $parlName := replaceRE `^.*?/parliaments/([^/]+).*` "$1" $path }}
    {{ if $parlName }}
      {{ $existing := index $byParliament $parlName | default (dict "main" slice "children" slice) }}
      {{ if eq $series "parliament" }}
        {{ $mainPages := $existing.main | append . }}
        {{ $existing = merge $existing (dict "main" $mainPages) }}
      {{ else }}
        {{ $childrenPages := $existing.children | append . }}
        {{ $existing = merge $existing (dict "children" $childrenPages) }}
      {{ end }}
      {{ $byParliament = merge $byParliament (dict $parlName $existing) }}
    {{ end }}
  
  {{ else if in $path "/industry/" }}
    {{ $parts := split (trim $path "/") "/" }}
    {{ if gt (len $parts) 2 }}
      {{ $industryType := index $parts 1 }}
      {{ $existing := index $byIndustryType $industryType | default slice }}
      {{ $existing = $existing | append . }}
      {{ $byIndustryType = merge $byIndustryType (dict $industryType $existing) }}
    {{ end }}
  
  {{ else if $series }}
    {{ $existing := index $bySeries $series | default slice }}
    {{ $existing = $existing | append . }}
    {{ $bySeries = merge $bySeries (dict $series $existing) }}
  {{ else }}
    {{ $standalone = $standalone | append . }}
  {{ end }}
{{ end }}

{{/* Function to extract departments and constituents */}}
{{- define "partials/extract-sections" -}}
  {{ $content := .Content }}
  {{ $output := dict }}
  
  {{ $splitContent := replace $content "<h2" "@@SPLIT@@<h2" }}
  {{ $sections := after 1 (split $splitContent "@@SPLIT@@") }}
  
  {{ range $sections }}
    {{ $section := . }}
    {{ $title := replaceRE "(?s)<h2[^>]*>(.*?)</h2>.*" "$1" $section | plainify | htmlUnescape | replaceRE `\s*#\s*$` "" }}
    
    {{ $ulMatch := findRE "(?s)<ul[^>]*>.*</ul>" $section 1 }}
    {{ if $ulMatch }}
      {{ $ul := index $ulMatch 0 }}
      {{ $output = merge $output (dict $title $ul) }}
    {{ end }}
  {{ end }}
  
  {{ return $output }}
{{- end -}}

{{/* Function to render extracted sections as HTML */}}
{{- define "partials/render-section-html" -}}
  {{ $ul := . }}
  {{ $scratch := newScratch }}
  <div class="extracted-section">
    {{ $content := replaceRE `(?s)^<ul[^>]*>\s*(.*?)\s*</ul>$` "$1" $ul }}
    {{ $nestedULs := findRE `(?s)<ul>.*?</ul>` $content }}
    {{ range $i, $nestedUL := $nestedULs }}
      {{ $placeholder := printf "@@UL_PLACEHOLDER_%d@@" $i }}
      {{ $scratch.Set $placeholder $nestedUL }}
      {{ $content = replace $content $nestedUL $placeholder }}
    {{ end }}
    {{ $delimitedContent := replaceRE `(?s)(</li>\s*)(<li)` "$1@@SPLIT@@$2" $content }}
    {{ $items := split $delimitedContent "@@SPLIT@@" }}
    {{ range $items }}
      {{ $item := . }}
      {{ $placeholderMatch := findRE `@@UL_PLACEHOLDER_\d+@@` $item }}
      {{ if $placeholderMatch }}
        {{ $placeholder := index $placeholderMatch 0 }}
        {{ $nestedUL := $scratch.Get $placeholder }}
        {{ $deptName := replaceRE `(?s)<li[^>]*>(.*?)@@UL_PLACEHOLDER_\d+@@.*` "$1" $item | htmlUnescape | safeHTML }}
        <div class="dept-group">
          <div class="dept-name">{{ $deptName }}</div>
          <div class="office-list">
            {{ $nestedContent := replaceRE `(?s)^<ul[^>]*>\s*(.*?)\s*</ul>$` "$1" $nestedUL }}
            {{ $nestedDelimited := replaceRE `(?s)(</li>\s*)(<li)` "$1@@SPLIT@@$2" $nestedContent }}
            {{ $nestedItems := split $nestedDelimited "@@SPLIT@@" }}
            {{ range $nestedItems }}
              {{ $office := replaceRE `(?s)<li[^>]*>(.*?)</li>` "$1" . | htmlUnescape | safeHTML }}
              <div class="office-item">{{ $office }}</div>
            {{ end }}
          </div>
        </div>
      {{ else }}
        {{ $itemContent := replaceRE `(?s)<li[^>]*>(.*?)</li>` "$1" $item | htmlUnescape | safeHTML }}
        <div class="dept-item">{{ $itemContent }}</div>
      {{ end }}
    {{ end }}
  </div>
{{- end -}}

{{/* --- MARKDOWN GENERATION --- */}}
{{ $markdown := "# Vekllei National Index\n\nComplete directory of government entities, ministries, parliaments, bureaus and state industries.\n\n---\n\n" }}
{{ if $byMinistry }}
  {{ $markdown = printf "%s## Ministries\n\n" $markdown }}
  {{ range $key, $group := $byMinistry }}
    {{ $niceName := replaceRE "-" " " $key | title }}
    {{ $markdown = printf "%s### %s\n\n" $markdown $niceName }}
    {{ range sort $group.main "Title" }}
      {{ $markdown = printf "%s* **%s**" $markdown .Title }}{{ if .Description }}{{ $markdown = printf "%s: %s" $markdown .Description }}{{ end }}{{ $markdown = printf "%s\n" $markdown }}
      {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}
        {{ $markdown = printf "%s\n  **%s**\n" $markdown $sectionTitle }}{{ $plainList := $sectionHTML | plainify | htmlUnescape }}{{ $lines := split $plainList "\n" }}{{ range $lines }}
          {{ $line := trim . " \t\n\r" }}{{ if $line }}{{ $markdown = printf "%s  - %s\n" $markdown $line }}{{ end }}
        {{ end }}{{ end }}
    {{ end }}
    {{ if $group.children }}
      {{ range sort $group.children "Title" }}
        {{ $markdown = printf "%s* **%s**" $markdown .Title }}{{ if .Description }}{{ $markdown = printf "%s: %s" $markdown .Description }}{{ end }}{{ $markdown = printf "%s\n" $markdown }}
        {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}
          {{ $markdown = printf "%s\n  **%s**\n" $markdown $sectionTitle }}{{ $plainList := $sectionHTML | plainify | htmlUnescape }}{{ $lines := split $plainList "\n" }}{{ range $lines }}
            {{ $line := trim . " \t\n\r" }}{{ if $line }}{{ $markdown = printf "%s  - %s\n" $markdown $line }}{{ end }}
          {{ end }}{{ end }}
      {{ end }}
    {{ end }}
    {{ $markdown = printf "%s\n" $markdown }}
  {{ end }}
{{ end }}
{{ if $byParliament }}
  {{ $markdown = printf "%s## Parliaments\n\n" $markdown }}
  {{ range $key, $group := $byParliament }}
    {{ $niceName := replaceRE "-" " " $key | title }}
    {{ $markdown = printf "%s### %s\n\n" $markdown $niceName }}
    {{ range sort $group.main "Title" }}
      {{ $markdown = printf "%s* **%s**" $markdown .Title }}{{ if .Description }}{{ $markdown = printf "%s: %s" $markdown .Description }}{{ end }}{{ $markdown = printf "%s\n" $markdown }}
      {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}
        {{ $markdown = printf "%s\n  **%s**\n" $markdown $sectionTitle }}{{ $plainList := $sectionHTML | plainify | htmlUnescape }}{{ $lines := split $plainList "\n" }}{{ range $lines }}
          {{ $line := trim . " \t\n\r" }}{{ if $line }}{{ $markdown = printf "%s  - %s\n" $markdown $line }}{{ end }}
        {{ end }}{{ end }}
    {{ end }}
    {{ if $group.children }}
      {{ range sort $group.children "Title" }}
        {{ $markdown = printf "%s* **%s**" $markdown .Title }}{{ if .Description }}{{ $markdown = printf "%s: %s" $markdown .Description }}{{ end }}{{ $markdown = printf "%s\n" $markdown }}
        {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}
          {{ $markdown = printf "%s\n  **%s**\n" $markdown $sectionTitle }}{{ $plainList := $sectionHTML | plainify | htmlUnescape }}{{ $lines := split $plainList "\n" }}{{ range $lines }}
            {{ $line := trim . " \t\n\r" }}{{ if $line }}{{ $markdown = printf "%s  - %s\n" $markdown $line }}{{ end }}
          {{ end }}{{ end }}
      {{ end }}
    {{ end }}
    {{ $markdown = printf "%s\n" $markdown }}
  {{ end }}
{{ end }}
{{ if $byIndustryType }}{{/* ... */}}{{ end }}
{{ if $bySeries }}{{/* ... */}}{{ end }}
{{ if $standalone }}{{/* ... */}}{{ end }}

{{/* --- HTML RENDERING --- */}}
<div class="government-directory">
  <div class="directory-header">
    <p class="directory-count">{{ len $allPages }} total entities <button id="download-md" class="button">â†“ Download Index</button></p>
  </div>

  {{ if $byMinistry }}
  <h2>Ministries</h2>
  {{ range $key, $group := $byMinistry }}
    {{ $niceName := replaceRE "-" " " $key | title }}
    <div class="note ministry-group">
      <h3>{{ $niceName }}</h3>
      <div class="ministry-children">
        {{ range sort $group.main "Title" }}
          <div class="child-org main-entry">
            <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
            {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
            {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
          </div>
        {{ end }}
        {{ if $group.children }}
          {{ range sort $group.children "Title" }}
            <div class="child-org">
              <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
              {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
              {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
            </div>
          {{ end }}
        {{ end }}
      </div>
    </div>
  {{ end }}
  {{ end }}

  {{ if $byParliament }}
  <h2>Parliaments</h2>
  {{ range $key, $group := $byParliament }}
    {{ $niceName := replaceRE "-" " " $key | title }}
    <div class="note panel parliament-group">
      <h3>{{ $niceName }}</h3>
      <div class="ministry-children">
        {{ range sort $group.main "Title" }}
          <div class="child-org main-entry">
            <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
            {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
            {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
          </div>
        {{ end }}
        {{ if $group.children }}
          {{ range sort $group.children "Title" }}
            <div class="child-org">
              <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
              {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
              {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
            </div>
          {{ end }}
        {{ end }}
      </div>
    </div>
  {{ end }}
  {{ end }}

  {{ if $byIndustryType }}
  <h2>Industries & Companies</h2>
  {{ range $key, $pages := $byIndustryType }}
    {{ $niceName := replaceRE "-" " " $key | title }}
    <div class="note panel industry-group">
      <h3>{{ $niceName }}</h3>
      <div class="ministry-children">
        {{ range sort $pages "Title" }}
          <div class="child-org">
            <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
            {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  {{ end }}

  {{ if $bySeries }}
    {{ range $series, $pages := $bySeries }}
      {{ $niceName := printf "%ss" ($series | title) }}
      <h2 style="margin-top: 2rem;">{{ $niceName }}</h2>
      <div class="note panel">
        <div class="ministry-children">
          {{ range sort $pages "Title" }}
            <div class="child-org main-entry">
              <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
              {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
              {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
            </div>
          {{ end }}
        </div>
      </div>
    {{ end }}
  {{ end }}

  {{ if $standalone }}
  <h2 style="margin-top: 2rem;">Other Government Entities</h2>
  <div class="note panel">
    <div class="ministry-children">
      {{ range sort $standalone "Title" }}
        <div class="child-org main-entry">
          <a href="{{ .RelPermalink }}" class="child-name">{{ .Title }}</a>
          {{ if .Description }}<em class="child-desc">{{ .Description }}</em>{{ end }}
          {{ $sections := partial "partials/extract-sections" . }}{{ range $sectionTitle, $sectionHTML := $sections }}<div class="section-container"><div class="section-title">{{ $sectionTitle }}</div>{{ partial "partials/render-section-html" $sectionHTML }}</div>{{ end }}
        </div>
      {{ end }}
    </div>
  </div>
  {{ end }}
</div>

<pre id="markdown-source" style="display:none;">{{ $markdown }}</pre>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('download-md');
  const markdownSource = document.getElementById('markdown-source');
  if (btn && markdownSource) {
    btn.addEventListener('click', function() {
      try {
        const markdown = markdownSource.textContent;
        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vekllei-national-index.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error("Markdown download failed:", e);
      }
    });
  }
});
</script>
<style>
.government-directory { font-size: 0.8rem; }
.government-directory h2 { font-size: 1.25rem; }
.government-directory h3 { font-size: 1rem; margin: 0 0 0.5rem 0; }
.directory-header { margin-bottom: 1rem; padding-bottom: 0.5rem; }
.directory-count { color: var(--gray-medium); font-size: 0.75rem; margin: 0; display: flex; align-items: center; justify-content: space-between; }
.note { margin-bottom: 1.5rem; font-size: small; line-height: normal; }

/* Main container for list items */
.ministry-children, .office-list { 
  position: relative; 
  padding-left: 1.25rem; /* Make space for the line */
}

.child-org::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: -1.25rem; /* Pull back to meet the vertical line */
  width: 1px;
  padding: 0.5rem 0;
  background-color: var(--gray-medium);
}

.office-list::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0rem;
  width: 1px;
  background-color: var(--gray-medium);
}

/* Individual list items */
.child-org, .dept-group, .dept-item { 
  position: relative; 
  padding-left: 0; /* Reset padding, spacing is handled by parent */
  border-left: none; /* Remove the old broken border */
  margin: 1rem 0;
}
.child-org.main-entry { padding: 0; }

.child-name { font-weight: 600; text-transform: uppercase; font-size: 1rem; margin-bottom: 0.15rem; }
.child-desc { display: block; font-size: 0.75rem; margin-bottom: 0.35rem; color: var(--gray-medium); }
.section-container { margin-top: 0.5rem; background: var(--gray-ultralight); border-radius: 0.25rem; }
.section-title { font-weight: bold; margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; letter-spacing: 0.03em; text-transform: uppercase; }

.dept-group { margin-bottom: 1rem; }
.office-list { margin-top: 1rem; }
.office-item { 
  font-style: italic; 
  font-size: 0.75rem; 
  margin-bottom: 0.15rem; 
  position: relative;
  border-left: none;
}
</style>